/**
 * @fileoverview Firestore Security Rules for EcoCity application.
 *
 * Core Philosophy:
 * This ruleset enforces a strict user-ownership model for user profiles, rewards, and user statistics,
 * while allowing public read access to products, recycling centers, and forum posts.
 *
 * Data Structure:
 * - /users/{userId}: User profiles, accessible only by the user themselves.
 * - /products/{productId}: Marketplace product listings, publicly readable, but writable only with valid owner.
 * - /recyclingcenters/{recyclingcenterId}: Recycling center data, publicly readable.
 * - /users/{userId}/rewards/{rewardId}: User-specific rewards, accessible only by the user themselves.
 * - /forumposts/{forumpostId}: Forum posts, publicly readable, but writable only with valid owner.
 * - /users/{userId}/userstats/{userstatsId}: User statistics, accessible only by the user themselves (1:1 relationship with UserProfile).
 *
 * Key Security Decisions:
 * - User listing is disallowed to protect privacy.
 * - Public read access is granted to products, recycling centers, and forum posts for discoverability.
 * - Strict ownership is enforced for user profiles, rewards, and user statistics.
 * - Data validation is limited to authorization-critical fields to enable rapid prototyping.
 *
 * Denormalization for Authorization:
 *  - The `sellerId` field in `products` and `authorId` field in `forumposts` are used to enforce ownership without requiring additional `get()` calls.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Protects general read and write access to the entire database.  Useful for testing rules.
     * @path /databases/{database}/documents
     * @allow (get): Always disallowed to enforce granular security.
     * @allow (list): Always disallowed to enforce granular security.
     * @allow (create): Always disallowed to enforce granular security.
     * @allow (update): Always disallowed to enforce granular security.
     * @allow (delete): Always disallowed to enforce granular security.
     * @principle Enforces granular security.
     */
    match /{document=**} {
      allow read, write: if false;
    }

    /**
     * @description Manages access to user profiles.
     * @path /users/{userId}
     * @allow (get): Allows a user to read their own profile.
     * @allow (list): Denies listing all users for privacy.
     * @allow (create): Allows a user to create their own profile (self-registration).
     * @allow (update): Allows a user to update their own profile.
     * @allow (delete): Allows a user to delete their own profile.
     * @deny (get): Denies reading another user's profile.
     * @deny (create): Denies creating a profile with a mismatched user ID.
     * @deny (update): Denies updating another user's profile.
     * @deny (delete): Denies deleting another user's profile.
     * @principle Enforces document ownership for reads and writes.
     */
    match /users/{userId} {
      allow get: if isOwner(userId);
      allow list: if false;
      allow create: if isOwner(userId) && request.resource.data.id == userId;
      allow update: if isExistingOwner(userId) && request.resource.data.id == resource.data.id;
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Manages access to marketplace product listings.
     * @path /products/{productId}
     * @allow (get): Allows anyone to read product listings.
     * @allow (list): Allows anyone to list product listings.
     * @allow (create): Allows a user to create a product listing if they are the seller.
     * @allow (update): Allows the seller to update their product listing.
     * @allow (delete): Allows the seller to delete their product listing.
     * @deny (create): Denies creating a product listing with a mismatched seller ID.
     * @deny (update): Denies updating a product listing if not the seller.
     * @deny (delete): Denies deleting a product listing if not the seller.
     * @principle Enforces document ownership for writes.
     */
    match /products/{productId} {
      allow get, list: if true;
      allow create: if isSignedIn() && request.resource.data.sellerId == request.auth.uid;
      allow update: if isExistingOwner(resource.data.sellerId);
      allow delete: if isExistingOwner(resource.data.sellerId);
    }

    /**
     * @description Manages access to recycling center data.
     * @path /recyclingcenters/{recyclingcenterId}
     * @allow (get): Allows anyone to read recycling center data.
     * @allow (list): Allows anyone to list recycling centers.
     * @allow (create): if false; // TODO: Add role-based access for admins to create recycling centers.
     * @allow (update): if false; // TODO: Add role-based access for admins to update recycling centers.
     * @allow (delete): if false; // TODO: Add role-based access for admins to delete recycling centers.
     * @principle Grants public read access.
     */
    match /recyclingcenters/{recyclingcenterId} {
      allow get, list: if true;
      allow create, update, delete: if false;
    }

    /**
     * @description Manages access to user-specific rewards.
     * @path /users/{userId}/rewards/{rewardId}
     * @allow (get): Allows a user to read their own rewards.
     * @allow (list): Allows a user to list their own rewards.
     * @allow (create): Allows a user to create a reward for themselves.
     * @allow (update): Allows a user to update their own reward.
     * @allow (delete): Allows a user to delete their own reward.
     * @deny (get): Denies reading another user's rewards.
     * @deny (list): Denies listing another user's rewards.
     * @deny (create): Denies creating a reward for another user.
     * @deny (update): Denies updating another user's rewards.
     * @deny (delete): Denies deleting another user's rewards.
     * @principle Enforces document ownership for reads and writes.
     */
    match /users/{userId}/rewards/{rewardId} {
      allow get, list: if isOwner(userId);
      allow create: if isOwner(userId) && request.resource.data.userId == userId;
      allow update: if isExistingOwner(userId) && request.resource.data.userId == resource.data.userId;
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Manages access to forum posts.
     * @path /forumposts/{forumpostId}
     * @allow (get): Allows anyone to read forum posts.
     * @allow (list): Allows anyone to list forum posts.
     * @allow (create): Allows a user to create a forum post if they are the author.
     * @allow (update): Allows the author to update their forum post.
     * @allow (delete): Allows the author to delete their forum post.
     * @deny (create): Denies creating a forum post with a mismatched author ID.
     * @deny (update): Denies updating a forum post if not the author.
     * @deny (delete): Denies deleting a forum post if not the author.
     * @principle Enforces document ownership for writes.
     */
    match /forumposts/{forumpostId} {
      allow get, list: if true;
      allow create: if isSignedIn() && request.resource.data.authorId == request.auth.uid;
      allow update: if isExistingOwner(resource.data.authorId);
      allow delete: if isExistingOwner(resource.data.authorId);
    }

    /**
     * @description Manages access to user statistics.
     * @path /users/{userId}/userstats/{userstatsId}
     * @allow (get): Allows a user to read their own statistics.
     * @allow (list): Allows a user to list their own statistics.
     * @allow (create): Allows a user to create statistics for themselves.
     * @allow (update): Allows a user to update their own statistics.
     * @allow (delete): Allows a user to delete their own statistics.
     * @deny (get): Denies reading another user's statistics.
     * @deny (list): Denies listing another user's statistics.
     * @deny (create): Denies creating statistics for another user.
     * @deny (update): Denies updating another user's statistics.
     * @deny (delete): Denies deleting another user's statistics.
     * @principle Enforces document ownership for reads and writes.
     */
    match /users/{userId}/userstats/{userstatsId} {
      allow get, list: if isOwner(userId);
      allow create: if isOwner(userId) && request.resource.data.id == userId;
      allow update: if isExistingOwner(userId) && request.resource.data.id == resource.data.id;
      allow delete: if isExistingOwner(userId);
    }

    // Helper functions
    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    function isExistingOwner(userId) {
      return isSignedIn() && isOwner(userId) && resource != null;
    }
  }
}