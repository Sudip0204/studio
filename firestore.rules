/**
 * @file Firestore Security Rules for EcoCity application.
 *
 * @core_philosophy This ruleset prioritizes user content visibility while ensuring data ownership and integrity. It enforces a balance between open access (read) and restricted modification (write) based on user authentication and roles.
 * @data_structure The Firestore database is structured with top-level collections for `users`, `forumposts`, and `leaderboard`, with a subcollection for `comments` under each `forumpost`.
 * @key_security_decisions
 *   - Any authenticated user can read user profiles and forum posts.
 *   - Only the owner (the authenticated user matching the document ID) can create, update, or delete their profile.
 *   - Forum posts are publicly readable, but creation, modification, and deletion are restricted to the post's author.
 *   - Leaderboard entries are publicly readable and writable to facilitate competition.
 * @denormalization_for_authorization None.
 * @structural_segregation None.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Allows any authenticated user to read user profiles, but only the owner can modify their own profile.
     * @path /users/{userId}
     * @allow (read) - Any logged-in user can read any user profile.
     * @allow (create, update, delete) - A user with UID 'user123' can create/update/delete the document at /users/user123.
     * @deny (create, update, delete) - A user with UID 'user456' cannot create/update/delete the document at /users/user123.
     * @principle Enforces document ownership for writes.
     */
    match /users/{userId} {
      allow get: if isSignedIn();
      allow list: if isSignedIn();
      allow create: if isSignedIn() && isOwner(userId);
      allow update: if isSignedIn() && isExistingOwner(userId);
      allow delete: if isSignedIn() && isExistingOwner(userId);
    }

    /**
     * @description Allows any authenticated user to read forum posts, but only the author can create, update, or delete them.
     * @path /forumposts/{postId}
     * @allow (read) - Any logged-in user can read any forum post.
     * @allow (create) - A user can create a forum post if the authorId matches their UID.
     * @allow (update, delete) - Only the author of the forum post can update or delete it.
     * @deny (create) - A user cannot create a forum post with an authorId that doesn't match their UID.
     * @deny (update, delete) - A different user cannot update or delete a forum post created by another user.
     * @principle Enforces content ownership for writes.
     */
    match /forumposts/{postId} {
      allow get: if isSignedIn();
      allow list: if isSignedIn();
      allow create: if isSignedIn() && request.resource.data.authorId == request.auth.uid;
      allow update: if isSignedIn() && isExistingOwnerForumPost(resource.data.authorId);
      allow delete: if isSignedIn() && isExistingOwnerForumPost(resource.data.authorId);
    }

    /**
     * @description Allows any authenticated user to read comments on forum posts, but only the author can create, update, or delete them.
     * @path /forumposts/{postId}/comments/{commentId}
     * @allow (read) - Any logged-in user can read any comment on any forum post.
     * @allow (create) - A user can create a comment if the authorId matches their UID.
     * @allow (update, delete) - Only the author of the comment can update or delete it.
     * @deny (create) - A user cannot create a comment with an authorId that doesn't match their UID.
     * @deny (update, delete) - A different user cannot update or delete a comment created by another user.
     * @principle Enforces content ownership for writes within a subcollection.
     */
    match /forumposts/{postId}/comments/{commentId} {
      allow get: if isSignedIn();
      allow list: if isSignedIn();
      allow create: if isSignedIn() && request.resource.data.authorId == request.auth.uid;
      allow update: if isSignedIn() && isExistingOwnerComment(resource.data.authorId);
      allow delete: if isSignedIn() && isExistingOwnerComment(resource.data.authorId);
    }

    /**
     * @description Allows any authenticated user to read leaderboard entries, and any authenticated user to create, update, or delete leaderboard entries.
     * @path /leaderboard/{scoreId}
     * @allow (read) - Any logged-in user can read any leaderboard entry.
     * @allow (create, update, delete) - Any logged-in user can create, update or delete any leaderboard entry.
     * @principle Allows public access to leaderboard data.
     */
    match /leaderboard/{scoreId} {
      allow get: if isSignedIn();
      allow list: if isSignedIn();
      allow create: if isSignedIn();
      allow update: if isSignedIn();
      allow delete: if isSignedIn();
    }

    // ---- Helper Functions ----

    /**
     * @description Checks if the user is signed in.
     * @return True if the user is signed in, false otherwise.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * @description Checks if the user ID matches the authenticated user's ID.
     * @param userId The user ID to compare against.
     * @return True if the user ID matches the authenticated user's ID, false otherwise.
     */
    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    /**
     * @description Checks if the user ID matches the authenticated user's ID and the resource exists.
     * @param userId The user ID to compare against.
     * @return True if the user ID matches the authenticated user's ID and the resource exists, false otherwise.
     */
    function isExistingOwner(userId) {
      return isOwner(userId) && resource != null;
    }

    /**
     * @description Checks if the authorId of the forum post matches the authenticated user's ID and the resource exists.
     * @param authorId The authorId to compare against.
     * @return True if the authorId matches the authenticated user's ID and the resource exists, false otherwise.
     */
    function isExistingOwnerForumPost(authorId) {
        return request.auth.uid == authorId && resource != null;
    }

    /**
     * @description Checks if the authorId of the comment matches the authenticated user's ID and the resource exists.
     * @param authorId The authorId to compare against.
     * @return True if the authorId matches the authenticated user's ID and the resource exists, false otherwise.
     */
    function isExistingOwnerComment(authorId) {
        return request.auth.uid == authorId && resource != null;
    }
  }
}