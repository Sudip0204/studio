/**
 * @fileoverview Firestore Security Rules for EcoCity application.
 *
 * Core Philosophy:
 * This ruleset prioritizes user data protection and enforces secure access to application resources.
 * It uses an ownership model for user profiles and a public-read, owner-write model for forum posts.
 * The ruleset is designed for rapid prototyping, focusing on authorization and access control while allowing flexible data shapes.
 *
 * Data Structure:
 * - /users/{userId}: Stores individual user profiles. Access is restricted to the owner.
 * - /forumposts/{postId}: Stores community forum posts. Read access is public, but writes are limited to the post author.
 * - /forumposts/{postId}/comments/{commentId}: Stores comments on forum posts.
 * - /leaderboard/{scoreId}: Stores Eco-Runner leaderboard entries.
 *
 * Key Security Decisions:
 * - User profiles are strictly private and accessible only to the authenticated user.
 * - Forum posts are publicly readable, fostering community engagement, but only the author can modify them.
 * - Leaderboard entries can be listed publicly.
 *
 * Denormalization for Authorization:
 * - Forum posts require the `authorId` field to enforce ownership for update and delete operations.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Secure user profiles, allowing only the owner to read and write their data.
     * @path /users/{userId}
     * @allow (create) - User with UID 'user123' can create their profile if request.auth.uid == 'user123'.
     * @allow (get, update, delete) - User with UID 'user123' can access their profile at /users/user123.
     * @deny (get) - User with UID 'user456' cannot access /users/user123.
     * @deny (update) - User with UID 'user456' cannot update /users/user123.
     * @principle Enforces document ownership for all operations on user profiles.
     */
    match /users/{userId} {
      function isOwner(userId) {
        return request.auth.uid == userId;
      }

      function isSignedIn() {
        return request.auth != null;
      }
      allow get: if isSignedIn() && isOwner(userId);
      allow list: if false;
      allow create: if isSignedIn() && isOwner(userId);
      allow update: if isSignedIn() && isOwner(userId);
      allow delete: if isSignedIn() && isOwner(userId);
    }

    /**
     * @description Rules for community forum posts. Read is public, but writes are restricted to the author.
     * @path /forumposts/{postId}
     * @allow (get, list) - Any user can read forum posts.
     * @allow (create) - User with UID 'user123' can create a post with authorId 'user123'.
     * @allow (update, delete) - Only the author of the post can modify or delete it.
     * @deny (create) - User with UID 'user123' cannot create a post with authorId 'user456'.
     * @deny (update) - User with UID 'user456' cannot update a post authored by 'user123'.
     * @principle Allows public read access but enforces ownership for write operations.
     */
    match /forumposts/{postId} {

      function isOwner() {
        return request.auth.uid == resource.data.authorId;
      }

      function isSignedIn() {
        return request.auth != null;
      }

      allow get: if true;
      allow list: if true;
      allow create: if isSignedIn() && request.resource.data.authorId == request.auth.uid;
      allow update: if isSignedIn() && isOwner();
      allow delete: if isSignedIn() && isOwner();
    }

    /**
     * @description Rules for comments on forum posts.
     * @path /forumposts/{postId}/comments/{commentId}
     */
    match /forumposts/{postId}/comments/{commentId} {

      function isOwner() {
        return request.auth.uid == resource.data.authorId;
      }

      function isSignedIn() {
        return request.auth != null;
      }

      allow get: if true;
      allow list: if true;
      allow create: if isSignedIn() && request.resource.data.authorId == request.auth.uid;
      allow update: if isSignedIn() && isOwner();
      allow delete: if isSignedIn() && isOwner();
    }

    /**
     * @description Rules for Eco-Runner leaderboard entries.
     * @path /leaderboard/{scoreId}
     * @allow (get, list) - Any user can view the leaderboard.
     * @allow (create) - Any signed-in user can submit a score.
     * @allow (update, delete) - No one can edit or delete existing scores.
     * @principle Allows public read access to the leaderboard.
     */
    match /leaderboard/{scoreId} {

      function isSignedIn() {
        return request.auth != null;
      }

      allow get: if true;
      allow list: if true;
      allow create: if isSignedIn();
      allow update: if false;
      allow delete: if false;
    }
  }
}