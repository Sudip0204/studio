rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Protects user profiles. Only the authenticated user can read or write their own profile.
     * @path /users/{userId}
     * @allow (get, create, update, delete, list) if the request is made by the user with matching ID.
     *   Example: A user with UID "user123" can read/write the document at /users/user123.
     * @deny (get, create, update, delete, list) if the request is made by a different user or unauthenticated user.
     *   Example: A user with UID "user456" cannot read/write the document at /users/user123.
     * @principle Enforces user-ownership for all operations on user profile data.
     */
    match /users/{userId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner(userId) {
        return request.auth.uid == userId;
      }

      function isExistingOwner(userId) {
        return isOwner(userId) && exists(resource);
      }

      allow get: if isSignedIn() && isOwner(userId);
      allow list: if false;
      allow create: if isSignedIn() && isOwner(userId);
      allow update: if isSignedIn() && isExistingOwner(userId);
      allow delete: if isSignedIn() && isExistingOwner(userId);
    }

    /**
     * @description Manages community forum posts. Anyone can read all posts, but only authenticated users can create, update, or delete their own posts.
     * @path /forumposts/{postId}
     * @allow (get, list) all users can read forum posts
     *   Example: Any user, authenticated or not, can view the content of /forumposts/post123.
     * @allow (create) Only authenticated users can create a post
     *   Example: A user with UID "user123" creates a post with authorId "user123".
     * @deny (create, update, delete) if not authenticated or not the author
     *   Example: An unauthenticated user cannot create a post. A user with UID "user456" cannot edit/delete a post authored by "user123".
     * @principle Public read access with owner-only writes.
     */
    match /forumposts/{postId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner() {
        return request.auth.uid == resource.data.authorId;
      }

      function isCreatingOwned() {
        return request.auth.uid == request.resource.data.authorId;
      }

      allow get, list: if true;
      allow create: if isSignedIn() && isCreatingOwned();
      allow update: if isSignedIn() && isOwner();
      allow delete: if isSignedIn() && isOwner();
    }

    /**
     * @description Manages comments on forum posts. Anyone can read all comments, but only authenticated users can create, update, or delete their own comments.
     * @path /forumposts/{postId}/comments/{commentId}
     * @allow (get, list) all users can read comments on a post
     *   Example: Any user can view comments under /forumposts/post123/comments/comment456.
     * @allow (create) only authenticated user can create comment, with authorId consistent with the current authenticated user.
     *   Example: User with UID "user123" can create a comment with authorId "user123" on post /forumposts/post456.
     * @deny (create, update, delete) if not authenticated or not the author.
     *   Example: An unauthenticated user cannot create a comment. User with UID "user456" cannot edit/delete comment by "user123".
     * @principle Public read access with owner-only writes.
     */
    match /forumposts/{postId}/comments/{commentId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner() {
        return request.auth.uid == resource.data.authorId;
      }

      function isCreatingOwned() {
        return request.auth.uid == request.resource.data.authorId;
      }

      allow get, list: if true;
      allow create: if isSignedIn() && isCreatingOwned();
      allow update: if isSignedIn() && isOwner();
      allow delete: if isSignedIn() && isOwner();
    }

    /**
     * @description Manages leaderboard entries. Anyone can read the leaderboard, but only authenticated users can submit a new entry.
     * @path /leaderboard/{scoreId}
     * @allow (get, list) any user can read leaderboard entries.
     *   Example: Any user can view scores under /leaderboard/score123.
     * @allow (create) only authenticated user can create a new leaderboard entry.
     *   Example: Authenticated user can create an entry in /leaderboard.
     * @deny (update, delete) Any user cannot update or delete a leaderboard entry.
     * @principle Public read access with authenticated user writes.
     */
    match /leaderboard/{scoreId} {
      function isSignedIn() {
        return request.auth != null;
      }

      allow get, list: if true;
      allow create: if isSignedIn();
      allow update: if false;
      allow delete: if false;
    }
  }
}