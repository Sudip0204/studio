/**
 * @file Firestore Security Rules for EcoCity application.
 *
 * Core Philosophy:
 * This ruleset prioritizes data security by implementing strict ownership and role-based access control.
 * User data is protected through ownership constraints, while forum posts and leaderboard entries have more open read access.
 *
 * Data Structure:
 * - /users/{userId}: User profile information, accessible only to the authenticated user.
 * - /communityPosts/{postId}: Community forum posts, publicly readable but with ownership-based write control.
 * - /communityPosts/{postId}/comments/{commentId}: Comments on forum posts, publicly readable, owner-based write.
 * - /leaderboard/{scoreId}: Leaderboard entries for Eco-Runner, publicly readable.
 *
 * Key Security Decisions:
 * - User profiles are private and only accessible to the respective authenticated user.
 * - Community posts are publicly readable but can only be created, updated, or deleted by their authors.
 * - Leaderboard entries are publicly readable to foster community engagement.
 * - Schema validation is relaxed in this prototyping phase.
 *
 * Denormalization for Authorization:
 * - Forum posts and comments include an `authorId` field to simplify ownership checks without needing additional reads.
 *
 * Structural Segregation:
 * - There is no structural segregation in this version.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Allows users to manage their own profile data.
     * @path /users/{userId}
     * @allow (create) User with UID 'user_abc' can create their profile at /users/user_abc.
     * @deny (create) User with UID 'user_abc' cannot create a profile at /users/user_xyz.
     * @allow (get) User with UID 'user_abc' can read their profile at /users/user_abc.
     * @deny (get) User with UID 'user_abc' cannot read profile at /users/user_xyz.
     * @allow (update) User with UID 'user_abc' can update their profile at /users/user_abc.
     * @deny (update) User with UID 'user_abc' cannot update profile at /users/user_xyz.
     * @allow (delete) User with UID 'user_abc' can delete their profile at /users/user_abc.
     * @deny (delete) User with UID 'user_abc' cannot delete profile at /users/user_xyz.
     * @principle Enforces document ownership for writes, restricts access to a user's own data tree, validates relational integrity between documents.
     */
    match /users/{userId} {
      function isOwner(userId) {
        return request.auth.uid == userId;
      }
      function isSignedIn() {
        return request.auth != null;
      }
      allow get: if isSignedIn() && isOwner(userId);
      allow list: if false;
      allow create: if isSignedIn() && isOwner(userId);
      allow update: if isSignedIn() && isOwner(userId);
      allow delete: if isSignedIn() && isOwner(userId);
    }

    /**
     * @description Allows anyone to read forum posts, but only the author can create, update, or delete.
     * @path /communityPosts/{postId}
     * @allow (create) User with UID 'user_abc' can create a post with authorId 'user_abc'.
     * @deny (create) User with UID 'user_abc' cannot create a post with authorId 'user_xyz'.
     * @allow (get) Any user can read a forum post.
     * @allow (list) Any user can list forum posts.
     * @allow (update) User with UID 'user_abc' can update a post they authored (resource.data.authorId == 'user_abc').
     * @deny (update) User with UID 'user_xyz' cannot update a post authored by 'user_abc'.
     * @allow (delete) User with UID 'user_abc' can delete a post they authored (resource.data.authorId == 'user_abc').
     * @deny (delete) User with UID 'user_xyz' cannot delete a post authored by 'user_abc'.
     * @principle Public read with owner-only writes, enforces document ownership for writes.
     */
    match /communityPosts/{postId} {
      function isSignedIn() {
        return request.auth != null;
      }
      allow get: if true;
      allow list: if true;
      allow create: if isSignedIn() && request.resource.data.authorId == request.auth.uid;
      allow update: if isSignedIn() && request.resource.data.authorId == request.auth.uid && resource.data.authorId == request.auth.uid;
      allow delete: if isSignedIn() && resource.data.authorId == request.auth.uid;
    }

    /**
     * @description Allows anyone to read comments, but only the author can create, update, or delete.
     * @path /communityPosts/{postId}/comments/{commentId}
     * @allow (create) User with UID 'user_abc' can create a comment with authorId 'user_abc'.
     * @deny (create) User with UID 'user_abc' cannot create a comment with authorId 'user_xyz'.
     * @allow (get) Any user can read a comment.
     * @allow (list) Any user can list comments.
     * @allow (update) User with UID 'user_abc' can update a comment they authored (resource.data.authorId == 'user_abc').
     * @deny (update) User with UID 'user_xyz' cannot update a comment authored by 'user_abc'.
     * @allow (delete) User with UID 'user_abc' can delete a comment they authored (resource.data.authorId == 'user_abc').
     * @deny (delete) User with UID 'user_xyz' cannot delete a comment authored by 'user_abc'.
     * @principle Public read with owner-only writes, enforces document ownership for writes.
     */
    match /communityPosts/{postId}/comments/{commentId} {
      function isSignedIn() {
        return request.auth != null;
      }
      allow get: if true;
      allow list: if true;
      allow create: if isSignedIn() && request.resource.data.authorId == request.auth.uid;
      allow update: if isSignedIn() && request.resource.data.authorId == request.auth.uid && resource.data.authorId == request.auth.uid;
      allow delete: if isSignedIn() && resource.data.authorId == request.auth.uid;
    }

    /**
     * @description Allows anyone to read leaderboard entries.
     * @path /leaderboard/{scoreId}
     * @allow (get) Any user can read a leaderboard entry.
     * @allow (list) Any user can list leaderboard entries.
     * @allow (create) Any signed in user can create a leaderboard entry.
     * @deny (update) No one can update a leaderboard entry.
     * @deny (delete) No one can delete a leaderboard entry.
     * @principle Public read, signed in user create.
     */
    match /leaderboard/{scoreId} {
      function isSignedIn() {
        return request.auth != null;
      }
      allow get: if true;
      allow list: if true;
      allow create: if isSignedIn();
      allow update: if false;
      allow delete: if false;
    }
  }
}