/**
 * @fileoverview Firestore Security Rules for EcoCity application.
 *
 * Core Philosophy:
 * This ruleset enforces a strict user-ownership model for user profiles and their associated data (rewards, stats).
 * Marketplace listings are secured using denormalized `sellerId` fields.
 * Public read access is granted to recycling centers and forum posts.
 *
 * Data Structure:
 * - /users/{userId}: User profiles, owned by the user.
 * - /users/{userId}/rewards/{rewardId}: Rewards associated with a user.
 * - /users/{userId}/userstats/{userstatsId}: Statistics for a user (1:1 with UserProfile).
 * - /marketlistings/{marketlistingId}: Marketplace listings, owned by the seller (denormalized `sellerId`).
 * - /recyclingcenters/{recyclingcenterId}: Recycling center data, publicly readable.
 * - /forumposts/{forumpostId}: Forum posts, publicly readable, owner-writeable.
 *
 * Key Security Decisions:
 * - Users can only read and write their own profile data and associated subcollections.
 * - Marketplace listings can be created by any authenticated user, but only the seller can update or delete them.
 * - Recycling center data and forum posts are publicly readable but only the owner can modify.
 * - Listing of user documents is allowed only for the owner.
 *
 * Denormalization for Authorization:
 * - Marketplace listings include the `sellerId` to allow direct authorization checks without additional reads.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Grants access to user profiles based on ownership.
     * @path /users/{userId}
     * @allow (create) User with UID "test_user" can create their profile if userId == auth.uid.
     * @allow (get) User with UID "test_user" can read their profile if userId == auth.uid.
     * @allow (update) User with UID "test_user" can update their profile if userId == auth.uid and the document exists.
     * @allow (delete) User with UID "test_user" can delete their profile if userId == auth.uid and the document exists.
     * @deny (create) User with UID "other_user" cannot create a profile with userId == "test_user".
     * @deny (update) User with UID "other_user" cannot update profile with userId == "test_user".
     * @deny (delete) User with UID "other_user" cannot delete profile with userId == "test_user".
     * @principle Enforces document ownership for writes.
     */
    match /users/{userId} {
      function isOwner(userId) {
        return request.auth != null && request.auth.uid == userId;
      }
      function isExistingOwner(userId) {
        return isOwner(userId) && resource != null;
      }

      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isOwner(userId) && request.resource.data.id == userId;
      allow update: if isExistingOwner(userId) && request.resource.data.id == resource.data.id;
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Grants access to marketplace listings based on seller ownership.
     * @path /marketlistings/{marketlistingId}
     * @allow (create) User with UID "test_user" can create a listing. The 'sellerId' field must equal the auth.uid.
     * @allow (get) Any user can read any listing.
     * @allow (list) Any user can list all listings.
     * @allow (update) User with UID "test_user" can update a listing if they are the seller (sellerId == auth.uid) and the document exists.
     * @allow (delete) User with UID "test_user" can delete a listing if they are the seller (sellerId == auth.uid) and the document exists.
     * @deny (create) User with UID "test_user" cannot create a listing if the sellerId in the data does not match the auth.uid.
     * @deny (update) User with UID "other_user" cannot update listing with sellerId == "test_user".
     * @deny (delete) User with UID "other_user" cannot delete listing with sellerId == "test_user".
     * @principle Enforces document ownership for writes; public read access.
     */
    match /marketlistings/{marketlistingId} {
      function isOwner(sellerId) {
        return request.auth != null && request.auth.uid == sellerId;
      }
       function isExistingOwner(sellerId) {
        return isOwner(sellerId) && resource != null;
      }

      allow get, list: if true;
      allow create: if request.auth != null && request.resource.data.sellerId == request.auth.uid;
      allow update: if isExistingOwner(resource.data.sellerId);
      allow delete: if isExistingOwner(resource.data.sellerId);
    }

    /**
     * @description Grants public read access to recycling center data.
     * @path /recyclingcenters/{recyclingcenterId}
     * @allow (get) Any user can read recycling center data.
     * @allow (list) Any user can list recycling center data.
     * @deny (create) No user can create recycling center data.
     * @deny (update) No user can update recycling center data.
     * @deny (delete) No user can delete recycling center data.
     * @principle Public read access only.
     */
    match /recyclingcenters/{recyclingcenterId} {
      allow get, list: if true;
      allow create, update, delete: if false;
    }

    /**
     * @description Grants access to user rewards based on ownership.
     * @path /users/{userId}/rewards/{rewardId}
     * @allow (create) User with UID "test_user" can create a reward if userId == auth.uid.
     * @allow (get) User with UID "test_user" can read their reward if userId == auth.uid.
     * @allow (update) User with UID "test_user" can update their reward if userId == auth.uid and the document exists.
     * @allow (delete) User with UID "test_user" can delete their reward if userId == auth.uid and the document exists.
     * @deny (create) User with UID "other_user" cannot create a reward with userId == "test_user".
     * @deny (update) User with UID "other_user" cannot update reward with userId == "test_user".
     * @deny (delete) User with UID "other_user" cannot delete reward with userId == "test_user".
     * @principle Enforces document ownership for writes.
     */
    match /users/{userId}/rewards/{rewardId} {
      function isOwner(userId) {
        return request.auth != null && request.auth.uid == userId;
      }
       function isExistingOwner(userId) {
        return isOwner(userId) && resource != null;
      }

      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isOwner(userId);
      allow update: if isExistingOwner(userId);
      allow delete: if isExistingOwner(userId);
    }

     /**
      * @description Grants public read access to forum posts. Owner can modify.
      * @path /forumposts/{forumpostId}
      * @allow (get) Any user can read a forum post.
      * @allow (list) Any user can list forum posts.
      * @allow (create) Authenticated user can create a forum post where authorId matches user id
      * @allow (update) Authenticated user can update a forum post where authorId matches user id
      * @allow (delete) Authenticated user can delete a forum post where authorId matches user id
      * @deny (create) User with UID "test_user" cannot create a forum post if the authorId in the data does not match the auth.uid.
      * @deny (update) User with UID "other_user" cannot update a forumpost where authorId == "test_user".
      * @deny (delete) User with UID "other_user" cannot delete a forumpost where authorId == "test_user".
      * @principle Public read access; owner-only writes.
      */
    match /forumposts/{forumpostId} {
      function isOwner(authorId) {
          return request.auth != null && request.auth.uid == authorId;
      }
      function isExistingOwner(authorId) {
        return isOwner(authorId) && resource != null;
      }
      allow get, list: if true;
      allow create: if request.auth != null && request.resource.data.authorId == request.auth.uid;
      allow update: if isExistingOwner(resource.data.authorId);
      allow delete: if isExistingOwner(resource.data.authorId);
    }

    /**
     * @description Grants access to user statistics based on ownership.
     * @path /users/{userId}/userstats/{userstatsId}
     * @allow (create) User with UID "test_user" can create userstats if userId == auth.uid.
     * @allow (get) User with UID "test_user" can read their userstats if userId == auth.uid.
     * @allow (update) User with UID "test_user" can update their userstats if userId == auth.uid and the document exists.
     * @allow (delete) User with UID "test_user" can delete their userstats if userId == auth.uid and the document exists.
     * @deny (create) User with UID "other_user" cannot create userstats with userId == "test_user".
     * @deny (update) User with UID "other_user" cannot update userstats with userId == "test_user".
     * @deny (delete) User with UID "other_user" cannot delete userstats with userId == "test_user".
     * @principle Enforces document ownership for writes.
     */
    match /users/{userId}/userstats/{userstatsId} {
      function isOwner(userId) {
        return request.auth != null && request.auth.uid == userId;
      }
      function isExistingOwner(userId) {
        return isOwner(userId) && resource != null;
      }

      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isOwner(userId);
      allow update: if isExistingOwner(userId);
      allow delete: if isExistingOwner(userId);
    }
  }
}