/**
 * @file Firestore Security Rules
 * @description This ruleset enforces a strict user-ownership model for user profiles and their associated data (rewards, userstats).
 * Public read access is granted to marketplace listings, recycling centers, and forum posts.
 *
 * Data Structure:
 * - /users/{userId}: Stores user profiles.
 * - /users/{userId}/rewards/{rewardId}: Stores rewards associated with a specific user.
 * - /users/{userId}/userstats/{userstatsId}: Stores user statistics for a specific user.
 * - /products/{productId}: Stores marketplace product listings.
 * - /recyclingcenters/{recyclingcenterId}: Stores recycling center data.
 * - /forumposts/{forumpostId}: Stores forum posts.
 *
 * Key Security Decisions:
 * - User listing is disallowed.
 * - User profiles and associated data (rewards, userstats) are strictly owner-only for writes and listing.
 * - Marketplace listings, recycling centers, and forum posts are publicly readable.
 * - Owner-only writes for products and forum posts are based on an ownership field within the document.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Protects user profile data, allowing only the owner to read and write.
     * @path /users/{userId}
     * @allow (create) User with UID 'mtSSOgocCvM06h6Px60Op3pLKLE2' can create their profile at /users/mtSSOgocCvM06h6Px60Op3pLKLE2.
     * @allow (get, update, delete) User with UID 'mtSSOgocCvM06h6Px60Op3pLKLE2' can get, update, and delete their profile at /users/mtSSOgocCvM06h6Px60Op3pLKLE2.
     * @deny (create) User with UID 'anotherUser' cannot create a profile at /users/mtSSOgocCvM06h6Px60Op3pLKLE2.
     * @deny (get, update, delete) User with UID 'anotherUser' cannot get, update, or delete the profile at /users/mtSSOgocCvM06h6Px60Op3pLKLE2.
     * @principle Enforces document ownership for all operations.
     */
    match /users/{userId} {
      // Allow a user to read their own profile.
      allow get: if isSignedIn() && isOwner(userId);
      // Allow a user to list all profiles --> NONE SHALL PASS
      allow list: if false;
      // Allow a user to create their own profile, enforcing that the userId matches the authenticated user's ID.
      allow create: if isSignedIn() && isOwner(userId) && request.resource.data.id == userId;
      // Allow a user to update their own profile.  Enforce immutability of the userId
      allow update: if isSignedIn() && isExistingOwner(userId) && request.resource.data.id == resource.data.id;
      // Allow a user to delete their own profile.
      allow delete: if isSignedIn() && isExistingOwner(userId);
    }

    /**
     * @description Protects user reward data, allowing only the owner to read and write.
     * @path /users/{userId}/rewards/{rewardId}
     * @allow (create) User with UID 'mtSSOgocCvM06h6Px60Op3pLKLE2' can create a reward at /users/mtSSOgocCvM06h6Px60Op3pLKLE2/rewards/someRewardId.
     * @allow (get, update, delete) User with UID 'mtSSOgocCvM06h6Px60Op3pLKLE2' can get, update, and delete their reward at /users/mtSSOgocCvM06h6Px60Op3pLKLE2/rewards/someRewardId.
     * @deny (create) User with UID 'anotherUser' cannot create a reward at /users/mtSSOgocCvM06h6Px60Op3pLKLE2/rewards/someRewardId.
     * @deny (get, update, delete) User with UID 'anotherUser' cannot get, update, or delete the reward at /users/mtSSOgocCvM06h6Px60Op3pLKLE2/rewards/someRewardId.
     * @principle Enforces document ownership for all operations.
     */
    match /users/{userId}/rewards/{rewardId} {
      // Allow a user to read their own reward.
      allow get: if isSignedIn() && isOwner(userId);
      // Allow a user to list their own rewards.
      allow list: if isSignedIn() && isOwner(userId);
      // Allow a user to create their own reward.
      allow create: if isSignedIn() && isOwner(userId);
      // Allow a user to update their own reward.
      allow update: if isSignedIn() && isExistingOwner(userId);
      // Allow a user to delete their own reward.
      allow delete: if isSignedIn() && isExistingOwner(userId);
    }

    /**
     * @description Protects user stats data, allowing only the owner to read and write.
     * @path /users/{userId}/userstats/{userstatsId}
     * @allow (create) User with UID 'mtSSOgocCvM06h6Px60Op3pLKLE2' can create userstats at /users/mtSSOgocCvM06h6Px60Op3pLKLE2/userstats/someUserStatsId.
     * @allow (get, update, delete) User with UID 'mtSSOgocCvM06h6Px60Op3pLKLE2' can get, update, and delete their userstats at /users/mtSSOgocCvM06h6Px60Op3pLKLE2/userstats/someUserStatsId.
     * @deny (create) User with UID 'anotherUser' cannot create userstats at /users/mtSSOgocCvM06h6Px60Op3pLKLE2/userstats/someUserStatsId.
     * @deny (get, update, delete) User with UID 'anotherUser' cannot get, update, or delete the userstats at /users/mtSSOgocCvM06h6Px60Op3pLKLE2/userstats/someUserStatsId.
     * @principle Enforces document ownership for all operations.
     */
    match /users/{userId}/userstats/{userstatsId} {
      // Allow a user to read their own userstats.
      allow get: if isSignedIn() && isOwner(userId);
      // Allow a user to list their own userstats.
      allow list: if isSignedIn() && isOwner(userId);
      // Allow a user to create their own userstats.
      allow create: if isSignedIn() && isOwner(userId);
      // Allow a user to update their own userstats.
      allow update: if isSignedIn() && isExistingOwner(userId);
      // Allow a user to delete their own userstats.
      allow delete: if isSignedIn() && isExistingOwner(userId);
    }

    /**
     * @description Allows public read access to product listings while restricting write access to owners.
     * @path /products/{productId}
     * @allow (get, list) Any user can read product listings.
     * @allow (create) User with UID 'mtSSOgocCvM06h6Px60Op3pLKLE2' can create a product if sellerId is correct.
     * @allow (update, delete) User with UID 'mtSSOgocCvM06h6Px60Op3pLKLE2' can update or delete their own product listing.
     * @deny (create) User with UID 'anotherUser' cannot create a product with 'sellerId' set to another user's ID.
     * @deny (update, delete) User with UID 'anotherUser' cannot update or delete a product listing they don't own.
     * @principle Public read access with owner-only writes, validated by the 'sellerId' field.
     */
    match /products/{productId} {
      // Allow anyone to read product listings.
      allow get, list: if true;

      // Allow a user to create a product listing, validating that they are the seller.
      allow create: if isSignedIn() && request.resource.data.sellerId == request.auth.uid;

      // Allow a user to update or delete their own product listing.
      allow update, delete: if isSignedIn() && resource.data.sellerId == request.auth.uid && resource != null;
    }

    /**
     * @description Allows public read access to recycling centers, restricting write access.
     * @path /recyclingcenters/{recyclingcenterId}
     * @allow (get, list) Any user can read recycling center data.
     * @deny (create, update, delete) No user can create, update or delete recycling center data via client SDK.
     * @principle Public read access, no client-side writes allowed.
     */
    match /recyclingcenters/{recyclingcenterId} {
      // Allow anyone to read recycling center data.
      allow get, list: if true;

      // Prevent anyone from creating, updating, or deleting recycling center data.
      allow create, update, delete: if false;
    }

    /**
     * @description Allows public read access to forum posts while restricting write access to owners.
     * @path /forumposts/{forumpostId}
     * @allow (get, list) Any user can read forum posts.
     * @allow (create) User with UID 'mtSSOgocCvM06h6Px60Op3pLKLE2' can create a forum post if authorId is correct.
     * @allow (update, delete) User with UID 'mtSSOgocCvM06h6Px60Op3pLKLE2' can update or delete their own forum post.
     * @deny (create) User with UID 'anotherUser' cannot create a forum post with 'authorId' set to another user's ID.
     * @deny (update, delete) User with UID 'anotherUser' cannot update or delete a forum post they don't own.
     * @principle Public read access with owner-only writes, validated by the 'authorId' field.
     */
    match /forumposts/{forumpostId} {
      // Allow anyone to read forum posts.
      allow get, list: if true;

      // Allow a user to create a forum post, validating that they are the author.
      allow create: if isSignedIn() && request.resource.data.authorId == request.auth.uid;

      // Allow a user to update or delete their own forum post.
      allow update, delete: if isSignedIn() && resource.data.authorId == request.auth.uid && resource != null;
    }

    // Helper functions
    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    function isExistingOwner(userId) {
      return isSignedIn() && isOwner(userId) && resource != null;
    }
  }
}