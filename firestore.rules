rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Controls access to user profiles.
     * @path /users/{userId}
     * @allow (create) Authenticated user can create their own profile.
     * @allow (get, list, update, delete) Authenticated user can only access their own profile.
     * @deny (create) if the created user id does not match the authenticated user id.
     * @deny (update, delete) if the user does not own the profile.
     * @principle Enforces document ownership for all operations.
     */
    match /users/{userId} {
      function isOwner(userId) {
        return request.auth.uid == userId;
      }
      function isSignedIn() {
        return request.auth != null;
      }
      allow get: if isSignedIn() && isOwner(userId);
      allow list: if isSignedIn() && isOwner(userId);
      allow create: if isSignedIn() && request.auth.uid == userId;
      allow update: if isSignedIn() && isOwner(userId);
      allow delete: if isSignedIn() && isOwner(userId);
    }

    /**
     * @description Controls access to product listings.
     * @path /products/{productId}
     * @allow (get, list) Public read access to all product listings.
     * @allow (create) Authenticated users can create product listings with their sellerId.
     * @allow (update, delete) Only the seller can modify or delete their product listings.
     * @deny (create) if the sellerId doesn't match the authenticated user.
     * @deny (update, delete) if the user does not own the product.
     * @principle Allows public read access but enforces document ownership for writes.
     */
    match /products/{productId} {
      function isOwner() {
        return request.resource.data.sellerId == request.auth.uid;
      }
      function isSignedIn() {
        return request.auth != null;
      }
      allow get, list: if true;
      allow create: if isSignedIn() && request.resource.data.sellerId == request.auth.uid;
      allow update: if isSignedIn() && resource.data.sellerId == request.auth.uid;
      allow delete: if isSignedIn() && resource.data.sellerId == request.auth.uid;
    }

    /**
     * @description Controls access to recycling center data.
     * @path /recyclingcenters/{recyclingcenterId}
     * @allow (get, list) Public read access to all recycling centers.
     * @deny (create, update, delete) No user writes allowed.
     * @principle Public read-only access.
     */
    match /recyclingcenters/{recyclingcenterId} {
      allow get, list: if true;
      allow create, update, delete: if false;
    }

    /**
     * @description Controls access to user-specific rewards.
     * @path /users/{userId}/rewards/{rewardId}
     * @allow (get, list, create, update, delete) Authenticated user can only access their own rewards.
     * @deny (create, update, delete) if the user does not own the reward.
     * @principle Enforces document ownership for all operations.
     */
    match /users/{userId}/rewards/{rewardId} {
      function isOwner(userId) {
        return request.auth.uid == userId;
      }
      function isSignedIn() {
        return request.auth != null;
      }
      allow get: if isSignedIn() && request.auth.uid == userId;
      allow list: if isSignedIn() && request.auth.uid == userId;
      allow create: if isSignedIn() && request.auth.uid == userId;
      allow update: if isSignedIn() && request.auth.uid == userId;
      allow delete: if isSignedIn() && request.auth.uid == userId;
    }

    /**
     * @description Controls access to forum posts.
     * @path /forumposts/{postId}
     * @allow (get, list) Public read access to all forum posts.
     * @allow (create) Authenticated users can create forum posts.
     * @allow (update, delete) Only the author can modify or delete their forum posts.
     * @deny (create) if the authorId doesn't match the authenticated user.
     * @deny (update, delete) if the user does not own the post.
     * @principle Allows public read access but enforces document ownership for writes.
     */
    match /forumposts/{postId} {
      function isOwner() {
        return resource.data.authorId == request.auth.uid;
      }
      function isSignedIn() {
        return request.auth != null;
      }
      allow get, list: if true;
      allow create: if isSignedIn() && request.resource.data.authorId == request.auth.uid;
      allow update: if isSignedIn() && resource.data.authorId == request.auth.uid;
      allow delete: if isSignedIn() && resource.data.authorId == request.auth.uid;
    }

    /**
     * @description Controls access to comments on forum posts.
     * @path /forumposts/{postId}/comments/{commentId}
     * @allow (get, list) Public read access to all comments.
     * @allow (create) Authenticated users can create comments.
     * @allow (update, delete) Only the author can modify or delete their comments.
     * @deny (create) if the authorId doesn't match the authenticated user.
     * @deny (update, delete) if the user does not own the comment.
     * @principle Allows public read access but enforces document ownership for writes.
     */
    match /forumposts/{postId}/comments/{commentId} {
      function isOwner() {
        return resource.data.authorId == request.auth.uid;
      }
      function isSignedIn() {
        return request.auth != null;
      }
      allow get, list: if true;
      allow create: if isSignedIn() && request.resource.data.authorId == request.auth.uid;
      allow update: if isSignedIn() && resource.data.authorId == request.auth.uid;
      allow delete: if isSignedIn() && resource.data.authorId == request.auth.uid;
    }

    /**
     * @description Controls access to likes on forum posts.
     * @path /forumposts/{postId}/likes/{userId}
     * @allow (get, list) Public read access to all likes.
     * @allow (create) Authenticated users can like a post (create a like document).
     * @deny (create) if the userId doesn't match the authenticated user.
     * @deny (update, delete)  Likes are managed through creation and deletion, so updates are disallowed. Deletion is only permitted by the liking user.
     * @principle  Likes are created and deleted; updates are not supported.
     */
    match /forumposts/{postId}/likes/{userId} {
      function isOwner(userId) {
        return request.auth.uid == userId;
      }
      function isSignedIn() {
        return request.auth != null;
      }
      allow get, list: if true;
      allow create: if isSignedIn() && request.auth.uid == userId;
      allow update: if false;
      allow delete: if isSignedIn() && request.auth.uid == userId;
    }

    /**
     * @description Controls access to leaderboard entries.
     * @path /leaderboard/{scoreId}
     * @allow (get, list) Public read access to the leaderboard.
     * @allow (create) Authenticated users can submit their scores.
     * @deny (create) if the userId doesn't match the authenticated user.
     * @deny (update, delete) No user writes allowed - admin only.
     * @principle Allows public read access and user-submitted scores, but restricts modifications.
     */
    match /leaderboard/{scoreId} {
      function isOwner() {
        return resource.data.userId == request.auth.uid;
      }
      function isSignedIn() {
        return request.auth != null;
      }
      allow get, list: if true;
      allow create: if isSignedIn() && request.resource.data.userId == request.auth.uid;
      allow update, delete: if false;
    }
  }
}