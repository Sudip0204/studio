/**
 * @fileoverview Firestore Security Rules for EcoCity application.
 *
 * Core Philosophy:
 * This ruleset enforces a strict user-ownership model for user profiles, rewards, and user statistics,
 * while allowing public read access to products, recycling centers, and forum posts.
 *
 * Data Structure:
 * - `/users/{userId}`: User profile information, accessible only by the user themselves.
 * - `/users/{userId}/rewards/{rewardId}`: User-specific rewards, accessible only by the user.
 * - `/users/{userId}/userstats/{userstatsId}`: User statistics, accessible only by the user. There will be a one-to-one mapping of users to stats documents.
 * - `/products/{productId}`: Marketplace product listings, publicly readable but writable only by the product owner.
 * - `/recyclingcenters/{recyclingcenterId}`: Recycling center data, publicly readable.
 * - `/forumposts/{forumpostId}`: Forum posts, publicly readable, writable only by the post author.
 *
 * Key Security Decisions:
 * - User listing is disallowed.
 * - Public read access is granted to product listings, recycling centers, and forum posts.
 * - The `createdAt` timestamp is not validated for maximum flexibility during prototyping.
 *
 * Denormalization for Authorization:
 * - Product documents MUST contain a `sellerId` field to enable owner-only writes.
 * - ForumPost documents MUST contain an `authorId` field to enable owner-only writes.
 *
 * Structural Segregation:
 * - Private user data (profiles, rewards, stats) is stored under the `/users/{userId}` path.
 * - Public data (products, recycling centers, forum posts) is stored in top-level collections.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Secures user profile data, allowing only the owner to read and write.
     * @path /users/{userId}
     * @allow (create) User with UID 'ARamd4717cXtwnX2e34GQaXxmRV2' can create their profile if request.auth.uid == userId.
     * @allow (get, update, delete) User with UID 'ARamd4717cXtwnX2e34GQaXxmRV2' can access their profile.
     * @deny (create) User with UID 'attackerUid' cannot create a profile with userId 'ARamd4717cXtwnX2e34GQaXxmRV2'.
     * @deny (get, update, delete) User with UID 'attackerUid' cannot access the profile of user with UID 'ARamd4717cXtwnX2e34GQaXxmRV2'.
     * @principle Enforces document ownership for user profiles.
     */
    match /users/{userId} {
      allow get: if isOwner(userId);
      allow list: if false; // User listing is not allowed.
      allow create: if isOwner(userId) && request.resource.data.id == userId;
      allow update: if isExistingOwner(userId) && request.resource.data.id == resource.data.id; // Enforce immutability of userId.
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Secures marketplace product listings, allowing public read access and owner-only writes.
     * @path /products/{productId}
     * @allow (get, list) Any user can read product listings.
     * @allow (create) User with UID 'user123' can create a product if request.resource.data.sellerId == request.auth.uid.
     * @allow (update, delete) User with UID 'user123' can update/delete their product if they are the seller.
     * @deny (create) User with UID 'attackerUid' cannot create a product with sellerId 'user123'.
     * @deny (update, delete) User with UID 'attackerUid' cannot update/delete product owned by 'user123'.
     * @principle Enforces public read access with owner-only writes for products.
     */
    match /products/{productId} {
      allow get, list: if true;
      allow create: if isSignedIn() && request.resource.data.sellerId == request.auth.uid;
      allow update: if isSignedIn() && resource != null && resource.data.sellerId == request.auth.uid;
      allow delete: if isSignedIn() && resource != null && resource.data.sellerId == request.auth.uid;
    }

    /**
     * @description Secures recycling center data, allowing public read access.
     * @path /recyclingcenters/{recyclingcenterId}
     * @allow (get, list) Any user can read recycling center data.
     * @deny (create, update, delete) No one can create, update, or delete recycling center data through client calls.
     * @principle Provides public information about recycling centers.
     */
    match /recyclingcenters/{recyclingcenterId} {
      allow get, list: if true;
      allow create, update, delete: if false; // Only server-side modifications allowed.
    }

    /**
     * @description Secures user rewards, allowing only the owner to read and write.
     * @path /users/{userId}/rewards/{rewardId}
     * @allow (create) User with UID 'ARamd4717cXtwnX2e34GQaXxmRV2' can create a reward under their profile.
     * @allow (get, update, delete) User with UID 'ARamd4717cXtwnX2e34GQaXxmRV2' can access their rewards.
     * @deny (create) User with UID 'attackerUid' cannot create a reward for user with UID 'ARamd4717cXtwnX2e34GQaXxmRV2'.
     * @deny (get, update, delete) User with UID 'attackerUid' cannot access rewards of user with UID 'ARamd4717cXtwnX2e34GQaXxmRV2'.
     * @principle Enforces document ownership for user rewards.
     */
    match /users/{userId}/rewards/{rewardId} {
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isOwner(userId);
      allow update: if isExistingOwner(userId);
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Secures forum posts, allowing public read access and owner-only writes.
     * @path /forumposts/{forumpostId}
     * @allow (get, list) Any user can read forum posts.
     * @allow (create) User with UID 'user123' can create a forum post if request.resource.data.authorId == request.auth.uid.
     * @allow (update, delete) User with UID 'user123' can update/delete their forum post if they are the author.
     * @deny (create) User with UID 'attackerUid' cannot create a forum post with authorId 'user123'.
     * @deny (update, delete) User with UID 'attackerUid' cannot update/delete a forum post owned by 'user123'.
     * @principle Enforces public read access with owner-only writes for forum posts.
     */
    match /forumposts/{forumpostId} {
      allow get, list: if true;
      allow create: if isSignedIn() && request.resource.data.authorId == request.auth.uid;
      allow update: if isSignedIn() && resource != null && resource.data.authorId == request.auth.uid;
      allow delete: if isSignedIn() && resource != null && resource.data.authorId == request.auth.uid;
    }

    /**
     * @description Secures user statistics, allowing only the owner to read and write.
     * @path /users/{userId}/userstats/{userstatsId}
     * @allow (create) User with UID 'ARamd4717cXtwnX2e34GQaXxmRV2' can create their stats under their profile if request.auth.uid == userId.
     * @allow (get, update, delete) User with UID 'ARamd4717cXtwnX2e34GQaXxmRV2' can access their stats.
     * @deny (create) User with UID 'attackerUid' cannot create stats for user with UID 'ARamd4717cXtwnX2e34GQaXxmRV2'.
     * @deny (get, update, delete) User with UID 'attackerUid' cannot access stats of user with UID 'ARamd4717cXtwnX2e34GQaXxmRV2'.
     * @principle Enforces document ownership for user statistics.
     */
    match /users/{userId}/userstats/{userstatsId} {
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isOwner(userId);
      allow update: if isExistingOwner(userId);
      allow delete: if isExistingOwner(userId);
    }
  }

  // Helper functions
  function isSignedIn() {
    return request.auth != null;
  }

  function isOwner(userId) {
    return request.auth.uid == userId;
  }

  function isExistingOwner(userId) {
    return isOwner(userId) && resource != null;
  }
}