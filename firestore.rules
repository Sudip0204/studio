/**
 * @file Firestore Security Rules
 * @description This ruleset enforces a user-ownership model for user profiles,
 * allows public read access with owner-only writes for forum posts,
 * and permits public access to the leaderboard.
 *
 * Data Structure:
 * - /users/{userId}: Stores individual user profiles. Access is restricted to the owner.
 * - /forumposts/{postId}: Stores community forum posts. Publicly readable but owner-modifiable.
 * - /forumposts/{postId}/comments/{commentId}: Stores comments on forum posts.
 *   Write access controlled by the comment's author.
 * - /leaderboard/{scoreId}: Stores leaderboard entries. Publicly readable and writable.
 *
 * Key Security Decisions:
 * - User listing is disallowed for privacy.
 * - Forum posts are publicly readable to encourage community engagement.
 * - Leaderboard data is public to foster competition.
 * - Data validation is relaxed in this prototype, focusing on authorization.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Secure user profiles. Only the owner can read and write their own profile.
     * @path /users/{userId}
     * @allow (get, create, update, delete) User 'CgvVVlQBoxXFRisGKnMNWMkHaUj2' can (get, create, update, delete) their own profile.
     * @deny (get, create, update, delete) User 'DifferentUserID' cannot (get, create, update, delete) 'CgvVVlQBoxXFRisGKnMNWMkHaUj2' profile.
     * @principle Enforces document ownership for all operations.
     */
    match /users/{userId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner(userId) {
        return request.auth.uid == userId;
      }
      allow get: if isSignedIn() && isOwner(userId);
      allow list: if false;
      allow create: if isSignedIn() && isOwner(userId);
      allow update: if isSignedIn() && isOwner(userId);
      allow delete: if isSignedIn() && isOwner(userId);
    }

    /**
     * @description Forum posts are publicly readable, but only the author can modify or delete them.
     * @path /forumposts/{postId}
     * @allow (get, list) Any user can read forum posts.
     * @allow (create) User 'user123' can create a forum post with authorId 'user123'.
     * @allow (update, delete) User 'user123' can (update, delete) their own forum post.
     * @deny (update, delete) User 'otherUser' cannot (update, delete) a forum post authored by 'user123'.
     * @principle Allows public read access with owner-only writes.
     */
    match /forumposts/{postId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner() {
        return request.auth.uid == resource.data.authorId;
      }
      allow get, list: if true;
      allow create: if isSignedIn() && request.resource.data.authorId == request.auth.uid;
      allow update: if isSignedIn() && isOwner();
      allow delete: if isSignedIn() && isOwner();
    }

    /**
     * @description Comments on forum posts. Only the author can modify or delete their comments.
     * @path /forumposts/{postId}/comments/{commentId}
     * @allow (create) User 'user456' can create a comment with authorId 'user456'.
     * @allow (update, delete) User 'user456' can (update, delete) their own comment.
     * @deny (update, delete) User 'otherUser' cannot (update, delete) a comment authored by 'user456'.
     * @principle Enforces document ownership for comment modifications.
     */
    match /forumposts/{postId}/comments/{commentId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner() {
        return request.auth.uid == resource.data.authorId;
      }
      allow get, list: if true;
      allow create: if isSignedIn() && request.resource.data.authorId == request.auth.uid;
      allow update: if isSignedIn() && isOwner();
      allow delete: if isSignedIn() && isOwner();
    }

    /**
     * @description Leaderboard entries are publicly accessible and writable.
     * @path /leaderboard/{scoreId}
     * @allow (get, list, create, update, delete) Any user can (get, list, create, update, delete) leaderboard entries.
     * @principle Allows public read and write access.
     */
    match /leaderboard/{scoreId} {
      function isSignedIn() {
        return request.auth != null;
      }
      allow get, list: if true;
      allow create: if isSignedIn();
      allow update: if isSignedIn();
      allow delete: if isSignedIn();
    }
  }
}