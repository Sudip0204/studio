/**
 * @fileoverview Firestore Security Rules for EcoCity application.
 *
 * Core Philosophy:
 * This ruleset enforces a strict user-ownership model for user profiles, rewards, and user statistics.
 * Public read access is granted for marketplace listings, recycling centers, and forum posts,
 * but write access to these collections is restricted to authorized users (e.g., the item's seller or the post's author).
 *
 * Data Structure:
 * - /users/{userId}: User profiles, accessible only by the user themselves.
 * - /marketlistings/{marketlistingId}: Marketplace listings, readable by anyone, writable by the seller.
 * - /recyclingcenters/{recyclingcenterId}: Recycling center data, publicly readable.
 * - /users/{userId}/rewards/{rewardId}: User-specific rewards, accessible only by the user.
 * - /forumposts/{forumpostId}: Forum posts, publicly readable, writable by the author.
 * - /users/{userId}/userstats/{userstatsId}: User statistics, accessible only by the user.
 *
 * Key Security Decisions:
 * - Users can only access their own user profile data and associated subcollections (rewards, userstats).
 * - Marketplace listings, recycling centers, and forum posts are publicly readable to facilitate discovery and community engagement.
 * - The rules explicitly prevent listing of user profiles for privacy reasons.
 * - Write access to marketplace listings and forum posts is restricted to the item's seller or the post's author, respectively.
 *
 * Denormalization for Authorization:
 * - Marketplace listings include a 'sellerId' field to enable direct authorization checks without additional reads.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Defines whether a user is signed in.
     * @return {boolean} True if request.auth is not null, false otherwise.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * @description Checks if the request is made by the owner of the resource.
     * @param {string} userId - The user ID to compare with the request's auth UID.
     * @return {boolean} True if the request is authenticated and the user ID matches the auth UID.
     */
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    /**
     * @description Checks if the request is made by an existing owner of the resource.
     * @param {string} userId - The user ID to compare with the resource's owner ID.
     * @return {boolean} True if the resource exists, the request is authenticated, and the user ID matches the resource's owner ID.
     */
    function isExistingOwner(userId) {
      return resource != null && isOwner(userId);
    }
    
    /**
     * @description Rules for user profiles.
     * @path /users/{userId}
     * @allow (create) Signed-in user can create their own profile.
     * @allow (get) Signed-in user can read their own profile.
     * @allow (update) Signed-in user can update their own profile.
     * @deny (create) User tries to create a profile with a different ID.
     * @deny (get) User tries to read another user's profile.
     * @deny (update) User tries to update another user's profile.
     * @deny (delete) User tries to delete another user's profile.
     * @principle Enforces document ownership for writes.
     */
    match /users/{userId} {
      allow get: if isOwner(userId);
      allow list: if false;
      allow create: if isOwner(userId) && request.resource.data.id == userId;
      allow update: if isExistingOwner(userId) && request.resource.data.id == resource.data.id;
      allow delete: if false;
    }

    /**
     * @description Rules for marketplace listings.
     * @path /marketlistings/{marketlistingId}
     * @allow (get) Anyone can read a marketplace listing.
     * @allow (list) Anyone can list marketplace listings.
     * @allow (create) Signed-in user can create a marketplace listing with their user ID as sellerId.
     * @allow (update) Seller can update their marketplace listing.
     * @deny (create) User tries to create a listing with a mismatched sellerId.
     * @deny (update) User tries to update a listing they don't own.
     * @deny (delete) User tries to delete a listing they don't own.
     * @principle Owner-only writes, public reads, authorization independence.
     */
    match /marketlistings/{marketlistingId} {
      allow get, list: if true;
      allow create: if isSignedIn() && request.resource.data.sellerId == request.auth.uid;
      allow update: if isSignedIn() && resource.data.sellerId == request.auth.uid;
      allow delete: if isSignedIn() && resource.data.sellerId == request.auth.uid;
    }

    /**
     * @description Rules for recycling centers.
     * @path /recyclingcenters/{recyclingcenterId}
     * @allow (get) Anyone can read a recycling center.
     * @allow (list) Anyone can list recycling centers.
     * @deny (create) No one can create a recycling center (admin only).
     * @deny (update) No one can update a recycling center (admin only).
     * @deny (delete) No one can delete a recycling center (admin only).
     * @principle Public reads, no writes allowed.
     */
    match /recyclingcenters/{recyclingcenterId} {
      allow get, list: if true;
      allow create, update, delete: if false;
    }

    /**
     * @description Rules for user rewards.
     * @path /users/{userId}/rewards/{rewardId}
     * @allow (create) Signed-in user can create their own reward.
     * @allow (get) Signed-in user can read their own reward.
     * @allow (update) Signed-in user can update their own reward.
     * @deny (create) User tries to create a reward for a different user.
     * @deny (get) User tries to read another user's reward.
     * @deny (update) User tries to update another user's reward.
     * @deny (delete) User tries to delete another user's reward.
     * @principle Enforces document ownership for writes.
     */
    match /users/{userId}/rewards/{rewardId} {
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isOwner(userId) && request.resource.data.userId == userId;
      allow update: if isExistingOwner(userId) && request.resource.data.userId == userId;
      allow delete: if false;
    }

    /**
     * @description Rules for forum posts.
     * @path /forumposts/{forumpostId}
     * @allow (get) Anyone can read a forum post.
     * @allow (list) Anyone can list forum posts.
     * @allow (create) Signed-in user can create a forum post.
     * @allow (update) Author can update their forum post.
     * @deny (create) Anonymous user tries to create a forum post.
     * @deny (update) User tries to update a post they don't own.
     * @deny (delete) User tries to delete a post they don't own.
     * @principle Owner-only writes, public reads.
     */
    match /forumposts/{forumpostId} {
      allow get, list: if true;
      allow create: if isSignedIn() && request.resource.data.authorId == request.auth.uid;
      allow update: if isSignedIn() && resource.data.authorId == request.auth.uid;
      allow delete: if isSignedIn() && resource.data.authorId == request.auth.uid;
    }

    /**
     * @description Rules for user statistics.
     * @path /users/{userId}/userstats/{userstatsId}
     * @allow (create) Signed-in user can create their own user statistics.
     * @allow (get) Signed-in user can read their own user statistics.
     * @allow (update) Signed-in user can update their own user statistics.
     * @deny (create) User tries to create statistics for a different user.
     * @deny (get) User tries to read another user's statistics.
     * @deny (update) User tries to update another user's statistics.
     * @deny (delete) User tries to delete another user's statistics.
     * @principle Enforces document ownership for writes.
     */
    match /users/{userId}/userstats/{userstatsId} {
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isOwner(userId) && request.resource.data.id == userId;
      allow update: if isExistingOwner(userId) && request.resource.data.id == resource.data.id;
      allow delete: if false;
    }
  }
}